# Error Handling

## 目的

- 失敗を「原因」ではなく「ユーザーの次の行動」に変換する
- CLI起因のエラーをUIで一貫して扱えるようにする

## エラー分類

### 認証

- 状況: `status` が未認証を返す / `login` が失敗
- UI: 認証画面を表示し、再試行可能にする

### CLI 実行

- `CLI_NOT_FOUND`: `bin/vidyeet-cli.exe` が見つからない/起動できない
- `CLI_TIMEOUT`: 一定時間応答しない
- `CLI_NON_ZERO_EXIT`: exit code 非0
- `CLI_BAD_JSON`: `--machine` 出力が JSON として解釈できない

UI:

- “再試行” を基本導線にする
- 失敗が認証起因の可能性が高い場合はログイン導線へ
- 開発向けには詳細（stderr / exit code）をログへ、ユーザーには簡潔なメッセージ

補足（現実装）:

- `status/login/logout/list/delete` は共通Runnerで統一エラーに変換する
- `upload` は進捗ストリームのため別実装で、JSON断片は無視しつつ、完了/失敗を検知してエラー化する

### ネットワーク/再生

- サムネイル/GIF/HLS URL 取得失敗
- UI: プレースホルダ + 「再生できません」等の軽いメッセージ

### 削除

- 状況: `delete` が失敗（CLI_NON_ZERO_EXIT 等）
- UI: ダイアログ内に失敗を表示し、再試行 or キャンセルできるようにする

### アップロード

- 状況: ファイル選択、アップロード実行、進捗取得で失敗
- UI:
	- ファイル選択キャンセルはエラーではなく無操作で終了
	- アップロード失敗はダイアログに表示し、閉じられること

#### 最小化状態でのエラー表示（2025-01実装）

**背景**: Nielsen Norman Group の人間工学的研究に基づき、エラーは即座に認識可能でなければならない（Error-Message Guidelines）。最小化状態でもエラーを見落とさないよう、視覚的フィードバックを強化する。

**視覚的指標（冗長性の原則）**:

1. **色**: 赤系の背景 + 赤枠（`rgba(239, 68, 68, 0.1)` + border）
2. **アイコン**: 赤色の警告アイコン（円+感嘆符）、スピナーと置き換え
3. **テキスト**: 「アップロード失敗」（赤色、font-weight: 500）

→ 3つの冗長な指標により、色覚異常のユーザーにもアクセシブル

**非表示にする要素**:

- 進捗率（`%`）: エラー時に進捗率を表示すると認知的混乱を招く
- ファイル名: 「アップロード失敗」という状態説明に置き換え

**インタラクション**:

- クリック: 最小化状態から通常状態に復元（詳細エラーメッセージ+閉じるボタン）
- ツールチップ: 「クリックして詳細を確認」

**設計判断の根拠**:

- **ノンモーダル維持**: エラー時も自動展開しない（NN/g: 長時間処理はユーザーに制御を与える）
- **視認性**: 目立つ、冗長で、アクセシブルな指標（NN/g Error Guidelines）
- **認知負荷**: シンプルな視覚言語（アイコン+短いテキスト）で即座に認識
- **効率性**: 1クリックで詳細とクローズにアクセス（ユーザーの労力を保護）
- **コミュニケーション**: 断定せず、次の行動（クリックして詳細確認）を提示

### クリップボード

- 状況: クリップボードへの書き込み失敗（OS制約/予期しない例外）
- UI: 現状はメニューを閉じるだけの簡易挙動。必要になったらトースト等に拡張する

## ログ方針

- 認証情報（アクセストークン/パスワード/生の token_id 等）はログに出さない
- CLI の stderr は開発時にのみ詳細を出し、将来はファイルログへ

現実装:

- 開発時のみ `cliRunner` が stderr/stdout を先頭500文字だけ `console.error` に出す
- 本番ビルドではログ出力しない（将来のファイルログ導入余地）

## リトライ方針

- `list` は再試行可能
- `login` は入力を保持して再試行可能
- 連続失敗時は「環境設定（プロキシ等）」の可能性を示す

現実装:

- `list` はエラー画面に「再試行」ボタンを出す
- `player` はエラーオーバーレイに「再試行」ボタンを出す

## 表示文言の原則

- "失敗しました" で終わらせず、次に押すべきボタンを提示する
- 不確実な原因推測は避ける（断定しない）
- 最小化状態では簡潔に（例: 「アップロード失敗」）、通常状態で詳細を表示
