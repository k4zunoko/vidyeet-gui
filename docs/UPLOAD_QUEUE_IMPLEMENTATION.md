# アップロードキュー実装レポート（Phase 1）

## 概要

複数ファイルの逐次アップロードを管理するキューシステムを実装しました。
ユーザーが複数のファイルを選択した際、自動的にキューに追加され、1ファイルずつ順次処理されます。

**実装日**: 2024年
**実装フェーズ**: Phase 1（基本キュー機能）
**設計原則準拠**: DESIGN_PHILOSOPHY.md - CLIが単一の真実、責務分離

## 実装の背景

### 課題

- 従来は単一ファイルのアップロードのみを想定
- 複数ファイルを選択した場合の処理が未定義
- ユーザーは1つずつファイルを選択する必要があった

### 解決方針

1. **逐次実行キュー**: CLIは1プロセス1ファイル設計のため、並列実行せず逐次処理
2. **エラー継続**: 1ファイル失敗しても次のファイルを処理
3. **個別リロード**: 各ファイル成功時に一覧を即座に更新
4. **既存アーキテクチャの維持**: CLI、IPC、進捗補間システムは変更不要

## 実装内容

### 新規ファイル

#### 1. `src/composables/useUploadQueue.ts`

**役割**: アップロードキューの状態管理とロジック

**主要機能**:
- `enqueue()`: ファイルをキューに追加
- `startNext()`: 次のアイテムを取得してアップロード開始
- `markCurrentCompleted()`: 現在のアイテムを完了状態にする
- `markCurrentError()`: 現在のアイテムをエラー状態にする
- `cancel()`: 待機中のアイテムをキャンセル
- `stats`: キューの統計情報（total, waiting, uploading, completed, error）

**設計特性**:
- Reactiveな状態管理（Vue 3 Composition API）
- 一意なIDによるアイテム管理
- ステータス遷移の明確化（waiting → uploading → completed/error）

### 修正ファイル

#### 1. `src/types/app.ts`

**追加内容**:
- `QueueItem`: キューアイテムの型定義
- `QueueItemStatus`: ステータス型（waiting/uploading/completed/error）
- `QueueStats`: 統計情報の型定義

#### 2. `src/App.vue`

**主要な変更**:

1. **キュー統合**:
   ```typescript
   const uploadQueue = useUploadQueue();
   ```

2. **複数ファイルハンドリング**:
   ```typescript
   async function handleMultipleFiles(files: File[]) {
     // ファイルパスを取得してキューに追加
     uploadQueue.enqueue(fileItems);
     // キューが処理中でなければ開始
     if (!uploadQueue.isProcessing.value) {
       await processUploadQueue();
     }
   }
   ```

3. **逐次実行ロジック**:
   ```typescript
   async function processUploadQueue() {
     const item = uploadQueue.startNext();
     if (!item) {
       // キュー完了処理
       return;
     }
     
     // アップロード実行
     const uploadResult = await window.vidyeet.upload(...);
     
     if (isIpcError(uploadResult)) {
       uploadQueue.markCurrentError(uploadResult.message);
       // 次のファイルを処理
       setTimeout(() => processUploadQueue(), 1000);
     } else {
       uploadQueue.markCurrentCompleted(uploadResult.assetId);
       // 個別リロード
       libraryRef.value?.reload();
       // 次のファイルを処理
       setTimeout(() => processUploadQueue(), 800);
     }
   }
   ```

4. **UI表示の拡張**:
   - ヘッダー: 複数ファイル時「アップロード中 (2/5)」表示
   - 待機中リスト: ファイル名とキャンセルボタン
   - 最小化バー: 単一ファイルは進捗率、複数ファイルは件数表示
   - キューアイテムのキャンセル機能

5. **スタイル追加**:
   - `.upload-queue`: キュー表示コンテナ
   - `.upload-queue-list`: 待機中リスト（max-height: 150px、スクロール対応）
   - `.upload-queue-item`: 各アイテムの表示
   - `.upload-queue-cancel`: キャンセルボタン（ホバーで赤色）

#### 3. ドキュメント更新

- `docs/ROADMAP.md`: Phase 1実装完了を記録
- `docs/UI_SPEC.md`: キュー表示仕様を追加
- `docs/ARCHITECTURE.md`: キュー管理の実装詳細を追記

## データフロー

### 複数ファイルアップロードの流れ

```
[ユーザー操作]
  ↓
  ファイル選択（複数）またはドラッグ&ドロップ
  ↓
[handleMultipleFiles()]
  ↓
  動画形式チェック → ファイルパス取得
  ↓
[useUploadQueue.enqueue()]
  ↓
  キューに追加（status: waiting）
  ↓
[processUploadQueue()]
  ↓
  キューから1つ取得（status: uploading）
  ↓
[既存のupload処理]
  ↓
  CLI実行（--machine upload <file> --progress）
  ↓
  進捗イベント → UI更新（進捗補間適用）
  ↓
[成功時]                    [失敗時]
  ↓                          ↓
markCurrentCompleted()     markCurrentError()
  ↓                          ↓
一覧リロード                トースト表示
  ↓                          ↓
次のファイル処理 ←----------┘
  ↓
[全ファイル完了]
  ↓
統計トースト表示
  ↓
キューをクリア
```

## UI/UX設計

### Nielsen Norman Group原則の適用

1. **ユーザー制御**: 
   - 待機中のファイルは個別にキャンセル可能
   - 最小化・復元で自由に操作

2. **ツァイガルニク効果**:
   - 待機中リストで未完了タスクを明示
   - 件数表示「2/5」で全体進捗を可視化

3. **エラー時の復帰**:
   - 1ファイル失敗しても他のファイルは処理継続
   - エラーファイルはキューに残り、状態を表示

4. **視覚的階層**:
   - 現在のファイルと待機中リストをボーダーで分離
   - キューセクションは控えめな表示（大文字ラベル、グレートーン）

### 表示仕様

#### ダイアログヘッダー

- **単一ファイル**: 「アップロード中」
- **複数ファイル**: 「アップロード中 (2/5)」

#### 最小化バー

- **単一ファイル**: ファイル名 + 進捗率（例: 65%）
- **複数ファイル**: ファイル名 + 件数（例: 2/5）

#### 待機中リスト

- セクション分離: 1rem上部マージン + ボーダー
- ヘッダー: 「待機中 (3件)」（小文字、グレー、大文字変換）
- リスト: 最大高150px、スクロール対応
- アイテム: ファイル名（省略表示）+ キャンセルボタン

## 技術的特徴

### 1. 既存システムとの統合

- **CLI**: 変更不要（1ファイルずつ実行）
- **IPC**: 変更不要（既存のuploadチャネルを使用）
- **進捗補間**: 変更不要（各アップロードで独立して動作）

### 2. エラーハンドリング

- **Resilient Design**: 1ファイル失敗しても次へ進む
- **エラー表示**: トースト通知 + ダイアログのエラー状態
- **統計表示**: 完了時「N件完了、M件失敗」

### 3. メモリ管理

- **完了後のクリア**: 全ファイル完了時にキューをクリア
- **アイテムの最小情報**: ID、パス、名前、ステータスのみ保持

### 4. パフォーマンス

- **逐次実行**: ネットワーク帯域を効率的に利用
- **個別リロード**: 各ファイル成功時に即座に一覧更新
- **非同期処理**: UIブロッキングなし（ノンモーダルダイアログ）

## 制約と将来拡張

### 現在の制約

1. **逐次実行のみ**: 並列アップロードは非対応
2. **キャンセル**: 待機中のみキャンセル可能（アップロード中は不可）
3. **再試行**: エラーアイテムの自動再試行は未実装
4. **並び替え**: キューの順序変更は未対応

### Phase 2での拡張候補

1. **再試行機能**: エラーアイテムに再試行ボタン
2. **アップロード中のキャンセル**: CLI プロセスの中断
3. **ドラッグ&ドロップ並び替え**: キューの順序変更
4. **一括キャンセル**: 待機中全アイテムの削除
5. **アップロード履歴**: 完了・エラーアイテムの保持と表示

### Phase 3での拡張候補

1. **並列アップロード**: 複数CLIプロセスの管理（要検討）
2. **レジューム機能**: 中断したアップロードの再開
3. **優先度設定**: キューアイテムの優先順位付け

## まとめ

Phase 1のアップロードキュー機能を実装しました。

**達成事項**:
- ✅ 複数ファイルの逐次アップロード
- ✅ キューの状態管理（useUploadQueue composable）
- ✅ 待機中リストの表示とキャンセル
- ✅ エラー継続処理（resilient design）
- ✅ 個別リロード（各ファイル成功時）
- ✅ UI/UX改善（件数表示、統計トースト）
- ✅ 既存システムとの統合（CLI/IPC/進捗補間）

**設計原則の遵守**:
- ✅ CLIが単一の真実（CLI側の変更不要）
- ✅ 責務分離（Renderer=状態管理、Main=CLI実行）
- ✅ 小さな契約で前進（既存アーキテクチャを壊さない）
- ✅ エラーハンドリングの一貫性

この実装により、ユーザーは複数のファイルを一度に選択でき、UIから進捗を確認しながら、他の操作を続けることができます。
